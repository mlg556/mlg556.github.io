<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2019-05-28" />
  <title>Guitar Tuner Term Project</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css" />
  <style>
      html, body {
          margin-top: 1%;
          margin-left: 10%;
          margin-right: 10%;
          background-color: #fbfbfb;
          color: #403f52;
          font-family: 'KaTeX_SansSerif';
          font-size: 18px;
      }

      img {
          max-width: 80%;
      }

      figcaption{
          font-style: italic;
      }

      pre code {
          display:inline-block;
          font-size: 14px;
          margin: 10px 10px 10px 10px;
      }

      code {
          display:inline-block;
          font-size: 14px;
      }

      .footer {
          text-align: center;
          margin-top: 1%;
          margin-bottom: 1%;
      }

      .date {
          font-style: italic;
      }

      a { color: inherit; }
  </style>

  <script src="https://kit.fontawesome.com/fa8004ee4c.js" crossorigin="anonymous"></script>

  <h1>
      <a href="/index.html" style="text-decoration:none">Miraç Lütfullah Gülgönül</a>
  </h1>

  <hr>

  <script defer=""
  src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Guitar Tuner Term Project</h1>
<p class="date">28 May 2019</p>
</header>
<h1 id="introduction">Introduction</h1>
<p>As a term project, we designed and implemented a guitar (or any
instrument) tuner device using the FRDM-KL25Z board, a microphone and an
OLED display. The tuner reads the sound from the microphone, breaks down
the signal into its frequency components, displays the frequency with
the most amplitude (the base frequency), and also displays the closest
musical note to that frequency, indicating whether the instrument should
be tuned up (higher pitch) or tuned down (lower pitch) to match that
closest musical note. An analog microphone is used to capture the input
audio signal, the FRDM-KL25Z board acts as the digital signal processor,
and a 128x64 OLED screen displays the user interface.</p>
<figure>
<img src="comp.jpg" style="width:50.0%" alt="The components used." />
<figcaption aria-hidden="true">The components used.</figcaption>
</figure>
<h1 id="theory">Theory</h1>
<p>By using Discrete Fourier Transform (DFT), one can decompose a
sampled discrete digital signal into a coefficient matrix which
represent the required “weights” to reproduce the sampled signal;
provided that the sampling frequency <span
class="math inline">F_s</span> is equal or greater than the bandwidth
<span class="math inline">B</span> of the input signal (due to
<em>Nyquist–Shannon sampling theorem</em>). A typical guitar can produce
sounds ranging from the note <span class="math inline">C2</span> (65.41
Hz) to <span class="math inline">F4</span> (349.23 Hz). To round things
off, a sampling frequency of <span class="math inline">1000 \text{
Hz}</span> will suffice to correctly analyse sounds up to <span
class="math inline">B4</span> (493 Hz). The incoming sound signal <span
class="math inline">x[t]</span> will be transformed into the frequency
domain <span class="math inline">X[jw]</span>. Then the magnitudes of
these complex coefficients will be calculated to produce <span
class="math inline">|X[jw]|</span>. Since the guitar sound contains many
harmonics, the frequency with the highest magnitude will be extracted,
and compared with the closest musical note.</p>
<h1 id="work-done">Work Done</h1>
<h2 id="setup">Setup</h2>
<p>The analog output of the microphone is connected to the board (via
the <code>PTC2</code> port) and the OLED screen is connected to the
board to enable I2C (Inter-Integrated Circuit) communications which
allows us to display the characters on the screen.</p>
<table>
<thead>
<tr class="header">
<th>Board Pins</th>
<th>OLED Display</th>
<th>Microphone </th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PTC2</td>
<td>-</td>
<td>Out</td>
</tr>
<tr class="even">
<td>PTC8</td>
<td>SCL</td>
<td>-</td>
</tr>
<tr class="odd">
<td>PTC9</td>
<td>SDA</td>
<td>-</td>
</tr>
</tbody>
</table>
<figure>
<img src="setup.jpg" style="width:30.0%"
alt="The connections between components." />
<figcaption aria-hidden="true">The connections between
components.</figcaption>
</figure>
<h2 id="code">Code</h2>
<p>The code itself is at Appendix A; this section describes the
behaviour.</p>
<h3 id="libraries">Libraries</h3>
<p>We will be using the <code>mbed</code> environment to program the
board. The library <code>mbed-dsp</code> contains functions
<code>arm_cfft_f32()</code> and <code>arm_cmplx_mag_f32()</code> to
calculate the Fourier transform and magnitudes of complex numbers
respectively. The library <code>FastAnalogIn</code> is used to sample
the input pin at the sampling frequency and read the input signal as an
array of 512 elements. The library <code>Adafruit_GFX</code> enables us
to draw shapes and text on the OLED screen.</p>
<h3 id="operation">Operation</h3>
<p>The array <code>float samples[FFT_SIZE*2]</code> holds the samples
read at each loop (note that the size is <code>FFT_SIZE*2</code> because
we need two elements for each complex coefficient). Then the function
<code>arm_cfft_f32()</code> is called with this array, overwriting it
with the complex coefficients <span class="math inline">a, b</span>. The
function <code>arm_cmplx_mag_f32()</code> processes this array to
calculate the magnitudes of these complex coefficients, putting them in
an array of type <code>float magnitudes[FFT_SIZE]</code>. The index of
the maximum element in this array corresponds to the base frequency of
the input audio signal. The closest musical note to this frequency is
calculated from a lookup table and the difference is stored to be
displayed. To eliminate possible noise, these values are displayed once
every 1024 loop: this trivially reduces response time, but greatly
increases the overall accuracy of the system.</p>
<figure>
<img src="demo.jpg" style="width:50.0%"
alt="Demonstration with an sinusoidal audio input of 392 Hz." />
<figcaption aria-hidden="true">Demonstration with an sinusoidal audio
input of 392 Hz.</figcaption>
</figure>
<h2 id="user-interface">User Interface</h2>
<p>The screen shows to the user the current frequency of the signal in
the first row, the second row shows the closest musical note, and how
far away it is. <em>Figure 4</em> shows an example scenario: the input
signals frequency is <em>433 Hz</em>, the closest musical note to this
frequency is <strong>A4</strong>, which is <em>440 Hz</em> so the user
has to tighten the string to increase the frequency by <strong>7
Hz</strong>.</p>
<figure>
<img src="ui.jpg" style="width:20.0%" alt="User interface." />
<figcaption aria-hidden="true">User interface.</figcaption>
</figure>
<h1 id="differences-between-proposal-and-work-done">Differences Between
Proposal and Work Done</h1>
<p>There exists two minor differences between the final product and the
proposal. The <em>FRDM-KL25Z</em> board uses the <em>Cortex-M0+</em>
architecture, which imposes a hardware limit on the biggest FFT size
(512 bins): since we are using a sampling rate of <em>1000 Hz</em> this
means a resolution of <span class="math inline">1000/512 =
1.95312</span>. As a result the sensitivity is about <span
class="math inline">\pm 1</span> Hz.</p>
<p>Also, the user interface is visually different than the proposed one
because of the limitations of the library <code>Adafruit_GFX</code> and
the size of the OLED screen <em>(128x64)</em>. Nevertheless the relevant
information is legibly displayed on the screen.</p>
<h1 id="conclusion">Conclusion</h1>
<p>All together, each group member spent about 12 hours for a total of
24. Group member <em>Miraç L. Gülgönül</em> was tasked with the audio
processing tasks: reading the signal from the pin with the sampling
rate, calculating the DTFT(Discrete-Time Fourier Transform) of the
signal and finding the corresponding frequency with the biggest
amplitude. Group member <em>S. Çağatay Çelebi</em> was tasked with
interfacing with the OLED screen using the libraries: displaying the
frequency, the musical note and the distance from the musical note.</p>
<p>This process was informative in various aspects such as collaborative
coding and division of labor. Also, the coding environment provided by
the <code>mbed</code> platform was very different from coding in
<code>8051-Assembly</code>. The code was easier to read, we could do
debugging and we could divide the code to components more easily.
Obviously each paradigm has its advantages: <code>Assembly</code> allows
for more compact and bare metal coding whereas <code>C++</code> provides
more abstraction and ease of coding: however at the modern age we
believe that programmer time is more important than processing time.</p>
<h1 id="appendices">Appendices</h1>
<h2 id="appendix-a">Appendix A</h2>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Instrument tuner using the FRDM-KL25Z Board. Written for EEE212 Term Project.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Miraç L. Gülgönül - S. Çağatay Çelebi</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * 20 May 2019</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;mbed.h&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;NVIC_set_all_priorities.h&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ctype.h&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;arm_math.h&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;arm_const_structs.h&quot;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;FastAnalogIn.h&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;TextLCD.h&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;Adafruit_GFX.h&quot;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;Adafruit_GFX_Config.h&quot;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;Adafruit_SSD1306.h&quot;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;glcdfont.h&quot;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>I2C comms<span class="op">(</span>PTC9<span class="op">,</span> PTC8<span class="op">);</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>Adafruit_SSD1306_I2c oled<span class="op">(</span>comms<span class="op">,</span> PTC3<span class="op">,</span> <span class="bn">0x78</span><span class="op">,</span> <span class="dv">64</span><span class="op">,</span> <span class="dv">128</span><span class="op">);</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>FastAnalogIn   Audio<span class="op">(</span>PTC2<span class="op">);</span> <span class="co">// INPUT</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Dummy ISR for disabling NMI on PTA4.</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">// More info at https://mbed.org/questions/1387/How-can-I-access-the-FTFA_FOPT-register-/</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="dt">void</span> NMI_Handler<span class="op">()</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    DigitalIn test<span class="op">(</span>PTA4<span class="op">);</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">// A guitar is at max from C2 to F4: which gives 65.41Hz to 349.23Hz</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Supported highest freq is 493 Hz, B4.</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> SAMPLE_RATE_HZ <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> WINDOW_SIZE <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// WAS 1024</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> NOTE_SIZE <span class="op">=</span> <span class="dv">39</span><span class="op">;</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> max_amp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> max_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> max_idxs<span class="op">[</span>WINDOW_SIZE<span class="op">];</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> window_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> FFT_SIZE <span class="op">=</span> <span class="dv">512</span><span class="op">;</span> <span class="co">// Size of the FFT.</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> <span class="at">const</span> notes<span class="op">[</span>NOTE_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;A1&quot;</span><span class="op">,</span> <span class="st">&quot;A#1&quot;</span><span class="op">,</span> <span class="st">&quot;B1&quot;</span><span class="op">,</span> <span class="st">&quot;C2&quot;</span><span class="op">,</span> <span class="st">&quot;C#2&quot;</span><span class="op">,</span> <span class="st">&quot;D2&quot;</span><span class="op">,</span> <span class="st">&quot;D#2&quot;</span><span class="op">,</span> <span class="st">&quot;E2&quot;</span><span class="op">,</span> <span class="st">&quot;F2&quot;</span><span class="op">,</span> <span class="st">&quot;F#2&quot;</span><span class="op">,</span> <span class="st">&quot;G2&quot;</span><span class="op">,</span> <span class="st">&quot;G#2&quot;</span><span class="op">,</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;A2&quot;</span><span class="op">,</span> <span class="st">&quot;A#2&quot;</span><span class="op">,</span> <span class="st">&quot;B2&quot;</span><span class="op">,</span> <span class="st">&quot;C3&quot;</span><span class="op">,</span> <span class="st">&quot;C#3&quot;</span><span class="op">,</span> <span class="st">&quot;D3&quot;</span><span class="op">,</span> <span class="st">&quot;D#3&quot;</span><span class="op">,</span> <span class="st">&quot;E3&quot;</span><span class="op">,</span> <span class="st">&quot;F3&quot;</span><span class="op">,</span> <span class="st">&quot;F#3&quot;</span><span class="op">,</span> <span class="st">&quot;G3&quot;</span><span class="op">,</span> <span class="st">&quot;G#3&quot;</span><span class="op">,</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;A3&quot;</span><span class="op">,</span> <span class="st">&quot;A#3&quot;</span><span class="op">,</span> <span class="st">&quot;B3&quot;</span><span class="op">,</span> <span class="st">&quot;C4&quot;</span><span class="op">,</span> <span class="st">&quot;C#4&quot;</span><span class="op">,</span> <span class="st">&quot;D4&quot;</span><span class="op">,</span> <span class="st">&quot;D#4&quot;</span><span class="op">,</span> <span class="st">&quot;E4&quot;</span><span class="op">,</span> <span class="st">&quot;F4&quot;</span><span class="op">,</span> <span class="st">&quot;F#4&quot;</span><span class="op">,</span> <span class="st">&quot;G4&quot;</span><span class="op">,</span> <span class="st">&quot;G#4&quot;</span><span class="op">,</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;A4&quot;</span><span class="op">,</span> <span class="st">&quot;A#4&quot;</span><span class="op">,</span> <span class="st">&quot;B4&quot;</span><span class="op">,</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> note_freqs<span class="op">[</span>NOTE_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="dv">55</span><span class="op">,</span> <span class="dv">58</span><span class="op">,</span> <span class="dv">62</span><span class="op">,</span> <span class="dv">65</span><span class="op">,</span> <span class="dv">69</span><span class="op">,</span> <span class="dv">73</span><span class="op">,</span> <span class="dv">78</span><span class="op">,</span> <span class="dv">82</span><span class="op">,</span> <span class="dv">87</span><span class="op">,</span> <span class="dv">92</span><span class="op">,</span> <span class="dv">98</span><span class="op">,</span> <span class="dv">103</span><span class="op">,</span> <span class="dv">110</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="dv">131</span><span class="op">,</span> <span class="dv">139</span><span class="op">,</span> <span class="dv">147</span><span class="op">,</span> <span class="dv">156</span><span class="op">,</span> <span class="dv">165</span><span class="op">,</span> <span class="dv">175</span><span class="op">,</span> <span class="dv">185</span><span class="op">,</span> <span class="dv">196</span><span class="op">,</span> <span class="dv">208</span><span class="op">,</span> <span class="dv">220</span><span class="op">,</span> <span class="dv">233</span><span class="op">,</span> <span class="dv">246</span><span class="op">,</span> <span class="dv">261</span><span class="op">,</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="dv">277</span><span class="op">,</span> <span class="dv">294</span><span class="op">,</span> <span class="dv">311</span><span class="op">,</span> <span class="dv">330</span><span class="op">,</span> <span class="dv">349</span><span class="op">,</span> <span class="dv">370</span><span class="op">,</span> <span class="dv">392</span><span class="op">,</span> <span class="dv">415</span><span class="op">,</span> <span class="dv">440</span><span class="op">,</span> <span class="dv">466</span><span class="op">,</span> <span class="dv">493</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> differences<span class="op">[</span><span class="dv">39</span><span class="op">];</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> min_diff <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> min_diff_idx <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>string closest_note <span class="op">=</span> notes<span class="op">[</span>min_diff_idx<span class="op">];</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="at">static</span> arm_cfft_instance_f32 <span class="op">*</span>S<span class="op">;</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>Ticker samplingTimer<span class="op">;</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> samples<span class="op">[</span>FFT_SIZE<span class="op">*</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> magnitudes<span class="op">[</span>FFT_SIZE<span class="op">];</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sampleCounter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co">// SAMPLING FUNCTIONS</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> samplingCallback<span class="op">()</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read from the ADC and store the sample data</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">[</span>sampleCounter<span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dv">1023</span> <span class="op">*</span> Audio<span class="op">)</span> <span class="op">-</span> <span class="fl">511.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Complex FFT functions require a coefficient for the imaginary part of the input.</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Since we only have real data, set this coefficient to zero.</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">[</span>sampleCounter<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update sample buffer position and stop after the buffer is filled</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    sampleCounter <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sampleCounter <span class="op">&gt;=</span> FFT_SIZE<span class="op">*</span><span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        samplingTimer<span class="op">.</span>detach<span class="op">();</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> samplingBegin<span class="op">()</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reset sample buffer position and start callback at necessary rate.</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    sampleCounter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    samplingTimer<span class="op">.</span>attach_us<span class="op">(&amp;</span>samplingCallback<span class="op">,</span> <span class="dv">1000000</span><span class="op">/</span>SAMPLE_RATE_HZ<span class="op">);</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> samplingIsDone<span class="op">()</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sampleCounter <span class="op">&gt;=</span> FFT_SIZE<span class="op">*</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="co">// MAIN FUNCTION</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    NVIC_set_all_irq_priorities<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    NVIC_SetPriority<span class="op">(</span>UART0_IRQn<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    oled<span class="op">.</span>setTextSize<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Begin sampling audio</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    samplingBegin<span class="op">();</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> <span class="op">&amp;</span> arm_cfft_sR_f32_len512<span class="op">;</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate FFT if a full sample is available.</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>samplingIsDone<span class="op">())</span> <span class="op">{</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Does a Hanning on samples:</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> FFT_SIZE<span class="op">*</span><span class="dv">2</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>                    samples<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> samples<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="dv">1</span><span class="op">-</span>cos<span class="op">(</span><span class="dv">2</span><span class="op">*</span><span class="fl">3.141592653589793</span><span class="op">/(</span>FFT_SIZE<span class="op">)));</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>                    samples<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Run FFT on sample data.</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>            arm_cfft_f32<span class="op">(</span>S<span class="op">,</span> samples<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate magnitude of complex numbers output by the FFT.</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>            arm_cmplx_mag_f32<span class="op">(</span>samples<span class="op">,</span> magnitudes<span class="op">,</span> FFT_SIZE<span class="op">);</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Restart audio sampling.</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>            samplingBegin<span class="op">();</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>        max_amp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>        max_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> FFT_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>magnitudes<span class="op">[</span>i<span class="op">]</span> <span class="op">&gt;</span> max_amp <span class="op">&amp;&amp;</span> i <span class="op">&lt;</span> <span class="dv">256</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>                max_amp <span class="op">=</span> magnitudes<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>                max_idx <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>        max_idxs<span class="op">[</span>window_idx<span class="op">]</span> <span class="op">=</span> max_idx<span class="op">;</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>window_idx <span class="op">==</span> WINDOW_SIZE <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>            window_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>            <span class="co">// sorts the array</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>            sort<span class="op">(</span>max_idxs<span class="op">,</span> max_idxs<span class="op">+</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>            <span class="co">// finds the most repeated element</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> repeat <span class="op">=</span> max_idxs<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> mode <span class="op">=</span> repeat<span class="op">;</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> mode_freq <span class="op">=</span> mode<span class="op">;</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> count_mode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> WINDOW_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span><span class="op">(</span>max_idxs<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> repeat<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>                    <span class="op">++</span>count<span class="op">;</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span><span class="op">(</span>count <span class="op">&gt;</span> count_mode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>                        count_mode <span class="op">=</span> count<span class="op">;</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>                        mode <span class="op">=</span> repeat<span class="op">;</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>                    count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>                    repeat <span class="op">=</span> max_idxs<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>            mode_freq <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>floor<span class="op">(</span>mode<span class="op">*</span><span class="fl">1.953125</span><span class="op">));</span> <span class="co">// for FFT_SIZE = 512, Fs = 1000.</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NOTE_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>                differences<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> mode_freq <span class="op">-</span> note_freqs<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>            min_diff <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>            min_diff_idx <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NOTE_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span><span class="op">(</span>abs<span class="op">(</span>differences<span class="op">[</span>i<span class="op">])</span> <span class="op">&lt;</span> min_diff<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>                    min_diff <span class="op">=</span> differences<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>                    min_diff_idx <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>            closest_note <span class="op">=</span> notes<span class="op">[</span>min_diff_idx<span class="op">];</span></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> mode_freq_str<span class="op">[</span><span class="dv">10</span><span class="op">];</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> closest_note_char<span class="op">[</span><span class="dv">10</span><span class="op">];</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> min_diff_char<span class="op">[</span><span class="dv">10</span><span class="op">];</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>            sprintf<span class="op">(</span>closest_note_char<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> closest_note<span class="op">);</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>            sprintf<span class="op">(</span>mode_freq_str<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> mode_freq<span class="op">);</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>            sprintf<span class="op">(</span>min_diff_char<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span>min_diff<span class="op">);</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>            oled<span class="op">.</span>clearDisplay<span class="op">();</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>            oled<span class="op">.</span>setTextCursor<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>                oled<span class="op">.</span>writeChar<span class="op">(</span>mode_freq_str<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>            oled<span class="op">.</span>writeChar<span class="op">(</span><span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">);</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>                oled<span class="op">.</span>writeChar<span class="op">(</span>closest_note_char<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>            oled<span class="op">.</span>writeChar<span class="op">(</span><span class="ch">&#39; &#39;</span><span class="op">);</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>            oled<span class="op">.</span>writeChar<span class="op">(</span><span class="ch">&#39; &#39;</span><span class="op">);</span></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">2</span> <span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>                oled<span class="op">.</span>writeChar<span class="op">(</span>min_diff_char<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>            oled<span class="op">.</span>display<span class="op">();</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>            window_idx <span class="op">=</span> window_idx <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr>

<div class="footer">

    <p>
        <small>somewhat ineptly hand-crafted by</small> Miraç Lütfullah Gülgönül
        <br>
        <a class="fa-solid fa-globe" style="text-decoration:none" href="https://mlg556.github.io"></a>
        &nbsp
        <a class="fa-regular fa-envelope" style="text-decoration:none" href="mailto:miraclgulgonul@gmail.com"></a>
        &nbsp
        <a class="fa-brands fa-linkedin" style="text-decoration:none" href="https://www.linkedin.com/in/mira%C3%A7-g%C3%BClg%C3%B6n%C3%BCl-b787841b5/"></a> 
    </p>


</div>

</body>
</html>
